<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gestão</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <aside class="sidebar">
        <div>
            <div class="logo-container">
                <div class="logo-box">EX</div>
                <div><h3 style="color:white; font-size: 1rem;">EXCEL</h3><span style="font-size: 0.7rem; color: #94a3b8;">Chaveiro & Segurança</span></div>
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" onclick="navegar('dashboard', this)"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
                
                <div class="nav-item" style="cursor: pointer;" onclick="toggleMenu()"><i class='bx bx-user'></i> <span style="flex:1;">Cadastros</span> <i class='bx bx-chevron-left' id="seta-cadastros"></i></div>
                <div class="sub-menu" id="menu-cadastros">
                    <a href="#" class="sub-item" onclick="navegar('clientes', this)"><span class="dot">•</span> Clientes</a>
                    <a href="#" class="sub-item" onclick="navegar('fornecedores', this)"><span class="dot">•</span> Fornecedores</a>
                    <a href="#" class="sub-item" onclick="navegar('funcionarios', this)"><span class="dot">•</span> Funcionários</a>
                </div>

                <a href="#" class="nav-item" onclick="navegar('produtos', this)"><i class='bx bx-box'></i> <span>Produtos</span></a>
            </div>
        </div>
        <div class="user-profile">
            <div class="avatar-circle">JN</div>
            <div style="flex: 1;"><h4 style="color: white; font-size: 0.9rem;">Usuário</h4><p style="font-size: 0.75rem; color: #94a3b8;">Logado</p></div>
            <i class='bx bx-log-out' style="cursor: pointer; font-size: 1.2rem;" onclick="window.location.href='index.html'"></i>
        </div>
    </aside>

    <main class="main-content">
        <section id="view-dashboard">
            <div class="header-title"><h1>Dashboard</h1><p>Visão geral do sistema</p></div>
            <div class="kpi-grid">
                <div class="card"><div class="icon-box-green"><i class='bx bx-dollar'></i></div><div class="card-label">Faturamento</div><div class="card-value">R$ 45k</div></div>
                <div class="card"><div class="card-label">Clientes</div><div class="card-value" id="total-clientes-dash">0</div></div>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><h3>Faturamento</h3><canvas id="lineChart"></canvas></div>
                <div class="chart-container"><h3>Serviços</h3><div style="height:200px; display:flex; justify-content:center;"><canvas id="doughnutChart"></canvas></div></div>
            </div>
        </section>

        <section id="view-clientes" style="display: none;">
            <div class="header-title"><h1>Clientes</h1><p id="total-clientes-sub">Gestão de base</p></div>
            <div class="toolbar"><div class="filter-tabs"><button class="tab-btn active">Todos</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><div class="search-bar"><i class='bx bx-search'></i><input type="text" placeholder="Buscar..."></div><button class="btn-new" onclick="abrirModalCliente()"><i class='bx bx-plus'></i> Novo Cliente</button></div>
            <div class="table-container"><table><thead><tr><th>Nome</th><th>Contato</th><th>Cidade</th><th>Status</th><th>Ações</th></tr></thead><tbody id="lista-clientes-body"></tbody></table></div>
        </section>

        <section id="view-fornecedores" style="display: none;">
            <div class="header-title"><h1>Fornecedores</h1><p id="total-forn-sub">Gestão de fornecedores</p></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 20px;"><div class="search-bar"><i class='bx bx-search'></i><input type="text" placeholder="Buscar..."></div><button class="btn-new" onclick="abrirModalFornecedor()"><i class='bx bx-plus'></i> Novo Fornecedor</button></div>
            <div class="table-container"><table><thead><tr><th>Fornecedor</th><th>Contato</th><th>Categoria</th><th>Status</th><th>Ações</th></tr></thead><tbody id="lista-fornecedores-body"></tbody></table></div>
        </section>

        <section id="view-funcionarios" style="display: none;">
            <div class="header-title"><h1>Funcionários</h1><p id="total-func-sub">Gestão de equipe</p></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 20px;"><div class="search-bar"><i class='bx bx-search'></i><input type="text" placeholder="Buscar..."></div><button class="btn-new" style="background: #1e3a8a;" onclick="abrirModalFuncionario()"><i class='bx bx-plus'></i> Novo Funcionário</button></div>
            <div class="table-container"><table><thead><tr><th>Funcionário</th><th>Cargo</th><th>Contato</th><th>Status</th><th>Ações</th></tr></thead><tbody id="lista-funcionarios-body"></tbody></table></div>
        </section>

        <section id="view-produtos" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="header-title">
                    <h1 style="display: flex; align-items: center; gap: 10px;"><div class="client-icon-box" style="background: #1e3a8a; color: white; width: 45px; height: 45px;"><i class='bx bx-package'></i></div> Produtos</h1>
                    <p id="total-prod-sub" style="margin-top: 5px;">0 produtos cadastrados</p>
                </div>
                <button class="btn-new" style="background: #1e3a8a;" onclick="abrirModalProduto()"><i class='bx bx-plus'></i> Novo Produto</button>
            </div>

            <div id="alerta-estoque" class="alert-warning" style="display: none;">
                <i class='bx bx-error-alt' style="font-size: 1.5rem;"></i>
                <span id="texto-alerta-estoque">0 produto(s) com estoque abaixo do mínimo</span>
            </div>

            <div class="toolbar">
                <div class="filter-tabs" id="abas-categorias" style="background: transparent; padding: 0;">
                    </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div class="search-bar" style="width: 400px;">
                    <i class='bx bx-search' style="color: #94a3b8;"></i>
                    <input type="text" placeholder="Buscar por nome, código ou código de barras...">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead><tr><th>Produto</th><th>Categoria</th><th>Estoque</th><th>Preços</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="lista-produtos-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-produto" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="titulo-modal-prod">Novo Produto</h3><i class='bx bx-x' style="font-size: 1.5rem; cursor: pointer; color: #64748b;" onclick="fecharModal('modal-produto')"></i></div>
            <form id="formProd">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group"><label>Código</label><input type="text" id="p_codigo" class="form-input"></div>
                        <div class="form-group"><label>Código de Barras</label><input type="text" id="p_barras" class="form-input"></div>
                        
                        <div class="form-group full-width"><label>Nome do Produto *</label><input type="text" id="p_nome" class="form-input" required></div>
                        <div class="form-group full-width"><label>Descrição</label><textarea id="p_desc" class="form-textarea" style="min-height: 60px;"></textarea></div>

                        <div class="form-group">
                            <label>Categoria *</label>
                            <input type="text" id="p_cat" class="form-input" list="lista-categorias" placeholder="Ex: Chaves, Caixas..." required>
                            <datalist id="lista-categorias">
                                </datalist>
                        </div>
                        
                        <div class="form-group"><label>Marca</label><input type="text" id="p_marca" class="form-input"></div>
                        <div class="form-group"><label>Unidade</label><select id="p_un" class="form-select"><option>Unidade</option><option>Caixa</option><option>Kg</option><option>Metro</option></select></div>

                        <div class="form-group"><label>Preço de Custo</label><input type="number" step="0.01" id="p_custo" class="form-input" placeholder="0.00"></div>
                        <div class="form-group"><label>Preço de Venda *</label><input type="number" step="0.01" id="p_venda" class="form-input" placeholder="0.00" required></div>

                        <div class="form-group"><label>Qtd em Estoque</label><input type="number" id="p_estoque" class="form-input" value="0"></div>
                        <div class="form-group"><label>Estoque Mínimo</label><input type="number" id="p_minimo" class="form-input" value="0"></div>
                        <div class="form-group"><label>Localização</label><input type="text" id="p_local" class="form-input" placeholder="Ex: A1-P2"></div>

                        <div class="form-group full-width" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div class="form-group"><label>URL da Imagem</label><input type="text" id="p_img" class="form-input"></div>
                            <div class="form-group"><label>Status</label><select id="p_status" class="form-select"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="fecharModal('modal-produto')">Cancelar</button><button type="submit" class="btn-save" style="background: #1e3a8a;">Cadastrar</button></div>
            </form>
        </div>
    </div>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('menu-cadastros');
            const seta = document.getElementById('seta-cadastros');
            if (menu.classList.contains('open')) { menu.classList.remove('open'); seta.classList.replace('bx-chevron-down', 'bx-chevron-left'); } 
            else { menu.classList.add('open'); seta.classList.replace('bx-chevron-left', 'bx-chevron-down'); }
        }

        let produtosData = [];
        let idEditandoProduto = null;
        let filtroAtivo = 'Todos';

        function navegar(tela, el) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item, .sub-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + tela).style.display = 'block';
            if(el) el.classList.add('active');
            
            // Aqui você chama as funções de carregar (Cole as outras aqui)
            if(tela === 'produtos') carregarProdutos();
        }

        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        // ==========================================
        // LÓGICA DE PRODUTOS (COM ABAS DINÂMICAS)
        // ==========================================
        function abrirModalProduto(id = null) { 
            idEditandoProduto = id;
            if(id) {
                document.getElementById('titulo-modal-prod').innerText = "Editar Produto";
                const p = produtosData.find(x => x.id === id);
                document.getElementById('p_codigo').value = p.codigo || ''; document.getElementById('p_barras').value = p.codigo_barras || '';
                document.getElementById('p_nome').value = p.nome; document.getElementById('p_desc').value = p.descricao || '';
                document.getElementById('p_cat').value = p.categoria || ''; document.getElementById('p_marca').value = p.marca || '';
                document.getElementById('p_un').value = p.unidade || 'Unidade'; document.getElementById('p_custo').value = p.preco_custo || '';
                document.getElementById('p_venda').value = p.preco_venda || ''; document.getElementById('p_estoque').value = p.estoque || 0;
                document.getElementById('p_minimo').value = p.estoque_minimo || 0; document.getElementById('p_local').value = p.localizacao || '';
                document.getElementById('p_img').value = p.imagem_url || ''; document.getElementById('p_status').value = p.status || 'Ativo';
            } else {
                document.getElementById('titulo-modal-prod').innerText = "Novo Produto";
                document.getElementById('formProd').reset();
            }
            document.getElementById('modal-produto').style.display = 'flex'; 
        }

        async function carregarProdutos() {
            try {
                const res = await fetch('/api/produtos'); // Mude pro link do render
                produtosData = await res.json();
                
                document.getElementById('total-prod-sub').innerText = `${produtosData.length} produtos cadastrados`;

                // 1. Calcular Estoque Baixo
                const comEstoqueBaixo = produtosData.filter(p => p.estoque < p.estoque_minimo);
                if(comEstoqueBaixo.length > 0) {
                    document.getElementById('alerta-estoque').style.display = 'flex';
                    document.getElementById('texto-alerta-estoque').innerText = `${comEstoqueBaixo.length} produto(s) com estoque abaixo do mínimo`;
                } else {
                    document.getElementById('alerta-estoque').style.display = 'none';
                }

                // 2. Mágica das Categorias Dinâmicas!
                // Pega todos os nomes de categorias usados e remove as duplicadas
                const categoriasUnicas = [...new Set(produtosData.map(p => p.categoria).filter(c => c && c.trim() !== ''))];
                
                // Atualiza as opções de autocomplete do formulário (datalist)
                document.getElementById('lista-categorias').innerHTML = categoriasUnicas.map(c => `<option value="${c}">`).join('');

                // Atualiza as abas de filtro na tela
                const abasHTML = `
                    <button class="tab-btn ${filtroAtivo === 'Todos' ? 'active' : ''}" onclick="setFiltroProduto('Todos')">Todos</button>
                    <button class="tab-btn ${filtroAtivo === 'Estoque Baixo' ? 'active' : ''}" onclick="setFiltroProduto('Estoque Baixo')" style="color: #ea580c;">Estoque Baixo (${comEstoqueBaixo.length})</button>
                    ${categoriasUnicas.map(cat => `<button class="tab-btn ${filtroAtivo === cat ? 'active' : ''}" onclick="setFiltroProduto('${cat}')">${cat}</button>`).join('')}
                `;
                document.getElementById('abas-categorias').innerHTML = abasHTML;

                renderizarTabelaProdutos();

            } catch (error) { console.error(error); }
        }

        function setFiltroProduto(filtro) {
            filtroAtivo = filtro;
            carregarProdutos(); // Recarrega para atualizar a cor das abas e a lista
        }

        function renderizarTabelaProdutos() {
            const tbody = document.getElementById('lista-produtos-body');
            
            // Filtra os dados com base na aba clicada
            let dadosFiltrados = produtosData;
            if (filtroAtivo === 'Estoque Baixo') {
                dadosFiltrados = produtosData.filter(p => p.estoque < p.estoque_minimo);
            } else if (filtroAtivo !== 'Todos') {
                dadosFiltrados = produtosData.filter(p => p.categoria === filtroAtivo);
            }

            if(dadosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class='bx bx-package'></i><p>Nenhum produto encontrado</p></td></tr>`;
                return;
            }

            tbody.innerHTML = dadosFiltrados.map(p => {
                const isEstoqueBaixo = p.estoque < p.estoque_minimo;
                const estoqueText = `<span class="${isEstoqueBaixo ? 'stock-alert-text' : ''}">${p.estoque} un ${isEstoqueBaixo ? "<i class='bx bx-error'></i>" : ""}</span>`;
                const statusClass = p.status === 'Ativo' ? 'status-active' : 'status-inactive';

                // Formatando valores para R$
                const custoFormatado = parseFloat(p.preco_custo || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const vendaFormatado = parseFloat(p.preco_venda || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                return `<tr>
                    <td>
                        <div class="user-cell">
                            <div class="client-icon-box" style="background:#f1f5f9; color:#94a3b8; width: 40px; height: 40px; border-radius: 8px;"><i class='bx bx-cube'></i></div>
                            <div><div style="font-weight: 600; color: #1e293b;">${p.nome}</div><div style="font-size: 0.75rem; color: #94a3b8;">${p.codigo || '-'}</div></div>
                        </div>
                    </td>
                    <td><div class="cat-tag"><i class='bx bx-tag'></i> ${p.categoria || 'Sem categoria'}</div></td>
                    <td><div style="font-weight: 600;">${estoqueText}</div></td>
                    <td><div class="prod-price-venda">${vendaFormatado}</div><div class="prod-price-custo">Custo: ${custoFormatado}</div></td>
                    <td><span class="status-badge ${statusClass}">${p.status || 'Ativo'}</span></td>
                    <td>
                        <button class="action-btn" onclick="abrirModalProduto(${p.id})"><i class='bx bx-edit-alt'></i></button>
                        <button class="action-btn" onclick="excluirProduto(${p.id})"><i class='bx bx-trash' style="color: #ef4444;"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        document.getElementById('formProd').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dados = {
                codigo: document.getElementById('p_codigo').value, codigo_barras: document.getElementById('p_barras').value,
                nome: document.getElementById('p_nome').value, descricao: document.getElementById('p_desc').value,
                categoria: document.getElementById('p_cat').value, // Ele pega a categoria nova que você digitou!
                marca: document.getElementById('p_marca').value, unidade: document.getElementById('p_un').value,
                preco_custo: document.getElementById('p_custo').value, preco_venda: document.getElementById('p_venda').value,
                estoque: document.getElementById('p_estoque').value, estoque_minimo: document.getElementById('p_minimo').value,
                localizacao: document.getElementById('p_local').value, imagem_url: document.getElementById('p_img').value,
                status: document.getElementById('p_status').value
            };

            const url = idEditandoProduto ? `/api/produtos/${idEditandoProduto}` : '/api/produtos';
            const method = idEditandoProduto ? 'PUT' : 'POST';

            await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            fecharModal('modal-produto'); carregarProdutos();
        });

        async function excluirProduto(id) { if(confirm("Excluir produto?")) { await fetch(`/api/produtos/${id}`, { method: 'DELETE' }); carregarProdutos(); } }

        window.onload = () => {
            carregarProdutos(); // Carrega produtos de inicio para testar
        }
    </script>
</body>
</html>
