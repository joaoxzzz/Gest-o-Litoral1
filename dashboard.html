<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gestão</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <aside class="sidebar">
        <div>
            <div class="logo-container">
                <div class="logo-box">EX</div>
                <div><h3 style="color:white; font-size: 1rem;">EXCEL</h3><span style="font-size: 0.7rem; color: #94a3b8;">Chaveiro & Segurança</span></div>
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" onclick="navegar('dashboard', this)"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
                <div class="nav-item" style="cursor: default;"><i class='bx bx-user'></i> <span style="flex:1;">Cadastros</span> <i class='bx bx-chevron-up'></i></div>
                <div class="sub-menu">
                    <a href="#" class="sub-item" onclick="navegar('clientes', this)"><span class="dot">•</span> Clientes</a>
                    <a href="#" class="sub-item" onclick="navegar('fornecedores', this)"><span class="dot">•</span> Fornecedores</a>
                    <a href="#" class="sub-item"><span class="dot">•</span> Funcionários</a>
                </div>
            </div>
        </div>
        <div class="user-profile">
            <div class="avatar-circle">JN</div>
            <div style="flex: 1;"><h4 style="color: white; font-size: 0.9rem;">Usuário</h4><p style="font-size: 0.75rem; color: #94a3b8;">Logado</p></div>
            <i class='bx bx-log-out' style="cursor: pointer; font-size: 1.2rem;" onclick="window.location.href='index.html'"></i>
        </div>
    </aside>

    <main class="main-content">
        <section id="view-dashboard">
            <div class="header-title"><h1>Dashboard</h1><p>Visão geral do sistema</p></div>
            <div class="kpi-grid">
                <div class="card"><div class="icon-box-green"><i class='bx bx-dollar'></i></div><div class="card-label">Faturamento</div><div class="card-value">R$ 45k</div></div>
                <div class="card"><div class="card-label">Clientes</div><div class="card-value" id="total-clientes-dash">0</div></div>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><h3>Faturamento</h3><canvas id="lineChart"></canvas></div>
                <div class="chart-container"><h3>Serviços</h3><div style="height:200px; display:flex; justify-content:center;"><canvas id="doughnutChart"></canvas></div></div>
            </div>
        </section>

        <section id="view-clientes" style="display: none;">
            <div class="header-title"><h1>Clientes</h1><p id="total-clientes-sub">Gestão de base</p></div>
            <div class="toolbar"><div class="filter-tabs"><button class="tab-btn active">Todos</button><button class="tab-btn">Pessoa Física</button><button class="tab-btn">Pessoa Jurídica</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="search-bar"><i class='bx bx-search' style="color: #94a3b8;"></i><input type="text" placeholder="Buscar por nome, CPF/CNPJ..."></div>
                <button class="btn-new" onclick="abrirModalCliente()"><i class='bx bx-plus'></i> Novo Cliente</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nome</th><th>Contato</th><th>Cidade</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="lista-clientes-body"></tbody>
                </table>
            </div>
        </section>

        <section id="view-fornecedores" style="display: none;">
            <div class="header-title"><h1>Fornecedores</h1><p id="total-forn-sub">Gestão de fornecedores</p></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 20px;">
                <div class="search-bar"><i class='bx bx-search' style="color: #94a3b8;"></i><input type="text" placeholder="Buscar fornecedor..."></div>
                <button class="btn-new" onclick="abrirModalFornecedor()"><i class='bx bx-plus'></i> Novo Fornecedor</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Fornecedor</th><th>Contato</th><th>Categoria</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="lista-fornecedores-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-cliente" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="titulo-modal-cliente">Novo Cliente</h3><i class='bx bx-x' style="font-size: 1.5rem; cursor: pointer; color: #64748b;" onclick="fecharModal('modal-cliente')"></i></div>
            <form id="formCli">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group"><label>Tipo</label><select id="c_tipo" class="form-select"><option value="Fisica">Pessoa Física</option><option value="Juridica">Pessoa Jurídica</option></select></div>
                        <div class="form-group"><label>Status</label><select id="c_status" class="form-select"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select></div>
                        <div class="form-group full-width"><label>Nome / Razão Social *</label><input type="text" id="c_nome" class="form-input" required></div>
                        <div class="form-group"><label>CPF / CNPJ</label><input type="text" id="c_doc" class="form-input"></div>
                        <div class="form-group"><label>RG / IE</label><input type="text" id="c_rg" class="form-input"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="c_email" class="form-input"></div>
                        <div class="form-group"><label>Telefone</label><input type="text" id="c_tel" class="form-input"></div>
                        <div class="form-group full-width"><label>WhatsApp</label><input type="text" id="c_whats" class="form-input"></div>
                        <div class="form-group full-width"><label>Endereço</label><input type="text" id="c_end" class="form-input"></div>
                        <div class="form-group full-width" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px;">
                            <div class="form-group"><label>Cidade</label><input type="text" id="c_cidade" class="form-input"></div>
                            <div class="form-group"><label>Estado</label><input type="text" id="c_uf" class="form-input"></div>
                            <div class="form-group"><label>CEP</label><input type="text" id="c_cep" class="form-input"></div>
                        </div>
                        <div class="form-group full-width"><label>Observações</label><textarea id="c_obs" class="form-textarea"></textarea></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="fecharModal('modal-cliente')">Cancelar</button><button type="submit" class="btn-save">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="modal-fornecedor" class="modal-overlay">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header"><h3 id="titulo-modal-forn">Novo Fornecedor</h3><i class='bx bx-x' style="font-size: 1.5rem; cursor: pointer; color: #64748b;" onclick="fecharModal('modal-fornecedor')"></i></div>
            <form id="formForn">
                <div class="modal-body">
                    <div class="form-grid" style="grid-template-columns: 1fr;">
                        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div><label>Categoria</label><select id="f_cat" class="form-select"><option>Equipamentos</option><option>Serviços</option><option>Peças</option><option>Diversos</option></select></div>
                            <div><label>Status</label><select id="f_status" class="form-select"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select></div>
                        </div>
                        <div class="form-group"><label>Nome / Razão Social *</label><input type="text" id="f_nome" class="form-input" required></div>
                        <div class="form-group"><label>CNPJ / CPF</label><input type="text" id="f_doc" class="form-input"></div>
                        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div><label>Telefone</label><input type="text" id="f_tel" class="form-input"></div>
                            <div><label>Email</label><input type="email" id="f_email" class="form-input"></div>
                        </div>
                        <div class="form-group"><label>Observações</label><textarea id="f_obs" class="form-textarea"></textarea></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn-cancel" onclick="fecharModal('modal-fornecedor')">Cancelar</button><button type="submit" class="btn-save">Salvar</button></div>
            </form>
        </div>
    </div>

    <script>
        // VARIAVEIS GLOBAIS PARA EDIÇÃO
        let clientesData = [];
        let fornecedoresData = [];
        let idEditandoCliente = null;
        let idEditandoFornecedor = null;

        function navegar(tela, el) {
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-clientes').style.display = 'none';
            document.getElementById('view-fornecedores').style.display = 'none';
            
            document.querySelectorAll('.nav-item, .sub-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + tela).style.display = 'block';
            if(el) el.classList.add('active');
            
            if(tela === 'clientes') carregarClientes();
            if(tela === 'fornecedores') carregarFornecedores();
        }

        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

        // ==========================================
        // LÓGICA DE CLIENTES
        // ==========================================
        function abrirModalCliente(id = null) { 
            idEditandoCliente = id;
            if(id) {
                document.getElementById('titulo-modal-cliente').innerText = "Editar Cliente";
                const c = clientesData.find(x => x.id === id);
                document.getElementById('c_tipo').value = c.tipo; document.getElementById('c_status').value = c.status;
                document.getElementById('c_nome').value = c.nome; document.getElementById('c_doc').value = c.documento;
                document.getElementById('c_rg').value = c.rg_ie || ''; document.getElementById('c_email').value = c.email || '';
                document.getElementById('c_tel').value = c.telefone || ''; document.getElementById('c_whats').value = c.whatsapp || '';
                document.getElementById('c_end').value = c.endereco || ''; document.getElementById('c_cidade').value = c.cidade || '';
                document.getElementById('c_uf').value = c.estado || ''; document.getElementById('c_cep').value = c.cep || '';
                document.getElementById('c_obs').value = c.observacoes || '';
            } else {
                document.getElementById('titulo-modal-cliente').innerText = "Novo Cliente";
                document.getElementById('formCli').reset();
            }
            document.getElementById('modal-cliente').style.display = 'flex'; 
        }

        async function carregarClientes() {
            try {
                const res = await fetch('/api/clientes'); // Lembre-se de colocar a URL do Render se estiver no Live Server
                clientesData = await res.json();
                document.getElementById('total-clientes-dash').innerText = clientesData.length;
                document.getElementById('total-clientes-sub').innerText = `${clientesData.length} clientes cadastrados`;

                const tbody = document.getElementById('lista-clientes-body');
                tbody.innerHTML = clientesData.map(c => {
                    const iconClass = c.tipo === 'Juridica' ? 'bx-building' : 'bx-user';
                    const colorClass = c.tipo === 'Juridica' ? 'icon-business' : 'icon-person';
                    const statusClass = c.status === 'Ativo' ? 'status-active' : 'status-inactive';

                    return `<tr>
                        <td><div class="user-cell"><div class="client-icon-box ${colorClass}"><i class='bx ${iconClass}'></i></div>
                            <div><div style="font-weight: 600; color: #1e293b;">${c.nome}</div><div style="font-size: 0.75rem; color: #94a3b8;">${c.documento || '-'}</div></div></div></td>
                        <td><div style="font-size: 0.9rem;">${c.telefone ? `<i class='bx bx-phone'></i> ${c.telefone}` : '-'}</div><div style="font-size: 0.8rem; color: #64748b;">${c.email || ''}</div></td>
                        <td><div style="display:flex; align-items:center; gap:5px; color:#64748b;"><i class='bx bx-map-pin'></i> ${c.cidade || '-'}</div></td>
                        <td><span class="status-badge ${statusClass}">${c.status || 'Ativo'}</span></td>
                        <td><button class="action-btn" onclick="abrirModalCliente(${c.id})"><i class='bx bx-edit-alt'></i></button>
                            <button class="action-btn" onclick="excluirCliente(${c.id})"><i class='bx bx-trash' style="color: #ef4444;"></i></button></td>
                    </tr>`;
                }).join('');
            } catch (error) { console.error(error); }
        }

        document.getElementById('formCli').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dados = {
                tipo: document.getElementById('c_tipo').value, status: document.getElementById('c_status').value,
                nome: document.getElementById('c_nome').value, documento: document.getElementById('c_doc').value,
                rg_ie: document.getElementById('c_rg').value, email: document.getElementById('c_email').value,
                telefone: document.getElementById('c_tel').value, whatsapp: document.getElementById('c_whats').value,
                endereco: document.getElementById('c_end').value, cidade: document.getElementById('c_cidade').value,
                estado: document.getElementById('c_uf').value, cep: document.getElementById('c_cep').value,
                observacoes: document.getElementById('c_obs').value
            };

            const url = idEditandoCliente ? `/api/clientes/${idEditandoCliente}` : '/api/clientes';
            const method = idEditandoCliente ? 'PUT' : 'POST';

            await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            fecharModal('modal-cliente'); carregarClientes();
        });

        async function excluirCliente(id) { if(confirm("Excluir cliente?")) { await fetch(`/api/clientes/${id}`, { method: 'DELETE' }); carregarClientes(); } }

        // ==========================================
        // LÓGICA DE FORNECEDORES
        // ==========================================
        function abrirModalFornecedor(id = null) { 
            idEditandoFornecedor = id;
            if(id) {
                document.getElementById('titulo-modal-forn').innerText = "Editar Fornecedor";
                const f = fornecedoresData.find(x => x.id === id);
                document.getElementById('f_cat').value = f.categoria || 'Diversos'; document.getElementById('f_status').value = f.status;
                document.getElementById('f_nome').value = f.nome; document.getElementById('f_doc').value = f.documento || '';
                document.getElementById('f_email').value = f.email || ''; document.getElementById('f_tel').value = f.telefone || '';
                document.getElementById('f_obs').value = f.observacoes || '';
            } else {
                document.getElementById('titulo-modal-forn').innerText = "Novo Fornecedor";
                document.getElementById('formForn').reset();
            }
            document.getElementById('modal-fornecedor').style.display = 'flex'; 
        }

        async function carregarFornecedores() {
            try {
                const res = await fetch('/api/fornecedores');
                fornecedoresData = await res.json();
                document.getElementById('total-forn-sub').innerText = `${fornecedoresData.length} fornecedores cadastrados`;

                const tbody = document.getElementById('lista-fornecedores-body');
                
                if(fornecedoresData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><i class='bx bx-archive-in'></i><p>Nenhum fornecedor encontrado</p></td></tr>`;
                    return;
                }

                tbody.innerHTML = fornecedoresData.map(f => {
                    const statusClass = f.status === 'Ativo' ? 'status-active' : 'status-inactive';
                    return `<tr>
                        <td><div class="user-cell"><div class="client-icon-box" style="background:#f3f4f6; color:#475569;"><i class='bx bx-package'></i></div>
                            <div><div style="font-weight: 600; color: #1e293b;">${f.nome}</div><div style="font-size: 0.75rem; color: #94a3b8;">${f.documento || '-'}</div></div></div></td>
                        <td><div style="font-size: 0.9rem;">${f.telefone ? `<i class='bx bx-phone'></i> ${f.telefone}` : '-'}</div><div style="font-size: 0.8rem; color: #64748b;">${f.email || ''}</div></td>
                        <td><div style="font-weight: 500; color:#64748b;">${f.categoria}</div></td>
                        <td><span class="status-badge ${statusClass}">${f.status || 'Ativo'}</span></td>
                        <td><button class="action-btn" onclick="abrirModalFornecedor(${f.id})"><i class='bx bx-edit-alt'></i></button>
                            <button class="action-btn" onclick="excluirFornecedor(${f.id})"><i class='bx bx-trash' style="color: #ef4444;"></i></button></td>
                    </tr>`;
                }).join('');
            } catch (error) { console.error(error); }
        }

        document.getElementById('formForn').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dados = {
                categoria: document.getElementById('f_cat').value, status: document.getElementById('f_status').value,
                nome: document.getElementById('f_nome').value, documento: document.getElementById('f_doc').value,
                email: document.getElementById('f_email').value, telefone: document.getElementById('f_tel').value,
                observacoes: document.getElementById('f_obs').value
            };

            const url = idEditandoFornecedor ? `/api/fornecedores/${idEditandoFornecedor}` : '/api/fornecedores';
            const method = idEditandoFornecedor ? 'PUT' : 'POST';

            await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            fecharModal('modal-fornecedor'); carregarFornecedores();
        });

        async function excluirFornecedor(id) { if(confirm("Excluir fornecedor?")) { await fetch(`/api/fornecedores/${id}`, { method: 'DELETE' }); carregarFornecedores(); } }

        // Inicialização e Máscaras
        window.onload = () => {
            carregarClientes();
            new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: ['Jan','Fev','Mar','Abr','Mai'], datasets: [{ label: 'R$', data: [15,30,12,20,45], borderColor: '#1e3a8a', tension: 0.4, fill: false }] } });
            new Chart(document.getElementById('doughnutChart'), { type: 'doughnut', data: { labels: ['Chaveiro','Alarmes'], datasets: [{ data: [70,30], backgroundColor: ['#1e3a8a','#fbbf24'], borderWidth: 0 }] }, options: { cutout: '70%' } });
        }

        // Máscaras de input...
        const docs = [document.getElementById('c_doc'), document.getElementById('f_doc')];
        docs.forEach(doc => {
            if(doc) doc.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g,"");
                if(v.length <= 11) { v = v.replace(/(\d{3})(\d)/,"$1.$2"); v = v.replace(/(\d{3})(\d)/,"$1.$2"); v = v.replace(/(\d{3})(\d{1,2})$/,"$1-$2"); } 
                else { v = v.replace(/^(\d{2})(\d)/,"$1.$2"); v = v.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3"); v = v.replace(/\.(\d{3})(\d)/,".$1/$2"); v = v.replace(/(\d{4})(\d)/,"$1-$2"); }
                e.target.value = v;
            });
        });
        
        const mascaraTelefone = (e) => {
            let v = e.target.value.replace(/\D/g,"");
            v = v.replace(/^(\d{2})(\d)/g,"($1) $2"); v = v.replace(/(\d)(\d{4})$/,"$1-$2"); e.target.value = v;
        };
        ['c_tel', 'c_whats', 'f_tel'].forEach(id => {
            if(document.getElementById(id)) document.getElementById(id).addEventListener('input', mascaraTelefone);
        });
        
        document.getElementById('c_cep').addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g,""); v = v.replace(/(\d{5})(\d)/,"$1-$2"); e.target.value = v;
        });
    </script>
</body>
</html>
