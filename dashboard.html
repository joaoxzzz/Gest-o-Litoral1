<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gestão</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <aside class="sidebar">
        <div>
            <div class="logo-container">
                <div class="logo-box">EX</div>
                <div><h3 style="color:white; font-size: 1rem;">EXCEL</h3><span style="font-size: 0.7rem; color: #94a3b8;">Chaveiro & Segurança</span></div>
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" onclick="navegar('dashboard', this)"><i class='bx bxs-dashboard'></i> <span>Dashboard</span></a>
                <div class="menu-category">Cadastros</div>
                <a href="#" class="nav-item" onclick="navegar('clientes', this)"><i class='bx bx-user'></i> <span>Clientes</span></a>
            </div>
        </div>
        <div class="user-profile">
            <div class="avatar-circle">JN</div>
            <div style="flex: 1;"><h4 style="color: white; font-size: 0.9rem;">Usuário</h4><p style="font-size: 0.75rem; color: #94a3b8;">Logado</p></div>
            <i class='bx bx-log-out' style="cursor: pointer; font-size: 1.2rem;" onclick="window.location.href='index.html'"></i>
        </div>
    </aside>

    <main class="main-content">
        <section id="view-dashboard">
            <div class="header-title"><h1>Dashboard</h1><p>Visão geral do sistema</p></div>
            <div class="kpi-grid">
                <div class="card"><div class="icon-box-green"><i class='bx bx-dollar'></i></div><div class="card-label">Faturamento</div><div class="card-value">R$ 45k</div></div>
                <div class="card"><div class="card-label">Clientes</div><div class="card-value" id="total-clientes-dash">0</div></div>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><h3>Faturamento</h3><canvas id="lineChart"></canvas></div>
                <div class="chart-container"><h3>Serviços</h3><div style="height:200px; display:flex; justify-content:center;"><canvas id="doughnutChart"></canvas></div></div>
            </div>
        </section>

        <section id="view-clientes" style="display: none;">
            <div class="header-title"><h1>Clientes</h1><p>Gestão de base</p></div>
            <div class="toolbar">
                <div class="filter-tabs"><button class="tab-btn active">Todos</button></div>
                <div style="display: flex; gap: 15px;">
                    <button class="btn-new" onclick="document.getElementById('modal-cliente').style.display='flex'"><i class='bx bx-plus'></i> Novo Cliente</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nome</th><th>Contato</th><th>Cidade</th><th>Ações</th></tr></thead>
                    <tbody id="lista-clientes-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-cliente" class="modal-overlay">
        <div class="modal-content">
            <h3>Novo Cliente</h3>
            <form id="formCli">
                <input type="text" id="c_nome" class="form-input" placeholder="Nome" required>
                <input type="text" id="c_doc" class="form-input" placeholder="Documento">
                <div class="modal-actions">
                    <button type="button" class="tab-btn" onclick="document.getElementById('modal-cliente').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-new" style="background: var(--active-yellow); color: var(--sidebar-bg);">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function navegar(tela, el) {
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-clientes').style.display = 'none';
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + tela).style.display = 'block';
            if(el) el.classList.add('active');
            if(tela === 'clientes') carregarClientes();
        }

        async function carregarClientes() {
            const res = await fetch('/api/clientes');
            const clientes = await res.json();
            document.getElementById('total-clientes-dash').innerText = clientes.length;
            document.getElementById('lista-clientes-body').innerHTML = clientes.map(c => `
                <tr>
                    <td><div class="user-cell"><div class="user-avatar-sm">${c.nome.substring(0,2).toUpperCase()}</div><div><strong>${c.nome}</strong><br><small>${c.documento||''}</small></div></div></td>
                    <td>${c.telefone||'-'}</td><td>${c.cidade||'-'}</td>
                    <td><button class="action-btn delete" onclick="excluir(${c.id})"><i class='bx bx-trash'></i></button></td>
                </tr>`).join('');
        }

        document.getElementById('formCli').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch('/api/clientes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome: document.getElementById('c_nome').value, documento: document.getElementById('c_doc').value }) });
            document.getElementById('modal-cliente').style.display = 'none';
            carregarClientes();
        });

        async function excluir(id) { if(confirm("Excluir?")) { await fetch(`/api/clientes/${id}`, { method: 'DELETE' }); carregarClientes(); } }

        window.onload = () => {
            carregarClientes();
            new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: ['Jan','Fev','Mar'], datasets: [{ label: 'R$', data: [15,30,45], borderColor: '#1e3a8a', tension: 0.4, fill: true }] } });
            new Chart(document.getElementById('doughnutChart'), { type: 'doughnut', data: { labels: ['A','B'], datasets: [{ data: [70,30], backgroundColor: ['#1e3a8a','#fbbf24'], borderWidth: 0 }] } });
        }
    </script>
</body>
</html>
